---
title: "Thesis Figures"
author: "Natasha Ryan"
output: 
  html_document: default
  word_document: default
editor_options: 
  chunk_output_type: inline
---

This RMD imports data to generate figures for Natasha Ryan's undergraduate honours thesis at Mount Allison University. 

```{r}
library(tidyverse)
```


# Methods 

```{r }
Fc_data <- readRDS("../Data/CleanData/LOW_Fragilariopsis_cylindrus_G0_SolFitsTrim.Rds")

s.col <- c("#003D4F","#375D97","#3397A6","#9FD4C2")

Fc_data %>%
  filter(Filename == "20230926_SeGu1001_0C_1s") %>%
  filter(Flashnumber <= 13) %>%
  ggplot() +
  geom_point(aes(x=Flashnumber, y=FvFmrunnorm, col=as.factor(SState))) +
  scale_color_manual(values = s.col) +
  #scale_y_continuous(limits=c(0.5, 1.1)) +
  scale_x_continuous(breaks=c(4,8,12))+
  labs(x= "Flash Number", y= "Normalized Chlorophyll Fluorescence") +
  theme_bw() +
  theme(legend.position = "none", text = element_text(family = "Palatino"), 
        axis.text=element_text(size=16), axis.title=element_text(size=14.8),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


# Results

### Representative Fluorescence Oscillations

```{r warning=FALSE}
Fc_data %>%
  filter(YYYYMMDD == "2023-09-27") %>%
  filter(Temp_C %in% c(0,10)) %>%
  filter(PulseSpace_s %in% c(1,4,16)) %>%
  ggplot() +
  geom_point(aes(x=Flashnumber, y=FvFmrunnorm, col=as.factor(SState))) +
  scale_color_manual(values = s.col) +
  labs(x= "Flash Number", y= "Normalized Chlorophyll Fluorescence", col= "S-State") +
  facet_grid(rows=vars(PulseSpace_s), cols=vars(Temp_C)) +
  scale_y_continuous(sec.axis=sec_axis(~ . , name = sym("Flash Spacing (s)"),breaks = NULL,labels = NULL)) +
  scale_x_continuous(breaks=c(4,8,12,16,20,24,28,32),
       sec.axis=sec_axis(~ . , name = sym("Measurement Temperature (°C)"), breaks = NULL, labels = NULL)) +
  theme_bw() +
  theme(text = element_text(family = "Times New Roman"), 
        axis.text=element_text(size=11), axis.title=element_text(size=13),
        legend.text=element_text(size=11), legend.title=element_text(size=13),
        strip.background = element_rect(colour="black", fill=NA),
        strip.text = element_text(size=11), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# ggsave("representativeoscillations.png", width = 8, height = 5, dpi = 900,
#       plot=last_plot(),
#       path="../Output")
```



### FFT




### Wavelet Power

```{r function}
plot.grid.data <- function(wavelets) {
  result_list <- lapply(names(wavelets), function(condition_name) {
    condition <- wavelets[[condition_name]]
    Power.avg <- condition$Power.avg
    Power.avg.pval <- condition$Power.avg.pval
    Period <- condition$Period
    Condition <- rep(condition_name, length(Power.avg))  # Repeat condition name for each row
    df <- data.frame(Power.avg, Power.avg.pval, Period, Condition) %>%
      separate(Condition, into = c("Temp_C", "PulseSpace_s"), sep = "_") 
    
    df$PulseSpace_s <- factor(df$PulseSpace_s, levels = c("1s","2s","4s","8s","16s"))
    
    return(df)
  })

  result_df <- bind_rows(result_list)  # Combine all data frames and add a column for element names
  return(result_df)
}
```


```{r Fc Periodicity Test}
Fc.TempDiff_C.avg <- plot.grid.data(FcWavelets) %>% 
  mutate(Temp_C = factor(Temp_C, levels = c("10C","6C","2C","0C"))) %>%
  mutate(Power.avg.pval = ifelse(Power.avg.pval <= 0.05, 0, 1))

Fc.TempDiff_C.avg %>%
  ggplot()+ 
  geom_path(aes(x= Power.avg, y= Period, col=Power.avg.pval), linewidth=0.8) +
  xlim(0, 1) + 
  scale_color_gradient(low="#4AC0AD", high="black", breaks= c(0.05, 1), labels= c("≤ 0.05", "> 0.05"), guide="legend") +
  labs(x= "Average Wavelet Power", colour= "P-Value") +
  facet_grid(rows=vars(Temp_C), cols = vars(PulseSpace_s)) +
  theme_linedraw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


```{r}
Ci.TempDiff_C.avg <- plot.grid.data(CiWavelets) %>%
  mutate(Temp_C = factor(Temp_C, levels = c("12C","8C","4C"))) %>%
  mutate(Power.avg.pval = ifelse(Power.avg.pval <= 0.05, 0, 1))

Ci.TempDiff_C.avg %>%
  ggplot()+ 
  geom_path(aes(x= Power.avg, y= Period, col=Power.avg.pval), linewidth=0.8) +
  xlim(0, 1) + 
  scale_color_gradient(low="#4AC0AD", high="black", breaks= c(0.05, 1), labels= c("≤ 0.05", "> 0.05"), guide="legend") +
  labs(x= "Average Wavelet Power", colour= "P-Value") +
  facet_grid(rows=vars(Temp_C), cols = vars(PulseSpace_s)) +
  theme_linedraw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

```{r}
Cm.TempDiff_C.avg <- plot.grid.data(CmWavelets) %>%
  mutate(Temp_C = factor(Temp_C, levels = c("12C","8C","4C"))) %>%
  mutate(Power.avg.pval = ifelse(Power.avg.pval <= 0.05, 0, 1))

Cm.TempDiff_C.avg %>%
  ggplot()+ 
  geom_path(aes(x= Power.avg, y= Period, col=Power.avg.pval), linewidth=0.8) +
  xlim(0, 1) + 
  scale_color_gradient(low="#4AC0AD", high="black", breaks= c(0.05, 1), labels= c("≤ 0.05", "> 0.05"), guide="legend") +
  labs(x= "Average Wavelet Power", colour= "P-Value") +
  facet_grid(rows=vars(Temp_C), cols = vars(PulseSpace_s)) +
  theme_linedraw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

```{r}
Cp.TempDiff_C.avg <- plot.grid.data(CpWavelets) %>%
  mutate(Temp_C = factor(Temp_C, levels = c("12C","8C","4C"))) %>%
  mutate(Power.avg.pval = ifelse(Power.avg.pval <= 0.05, 0, 1))

Cp.TempDiff_C.avg %>%
  ggplot()+ 
  geom_path(aes(x= Power.avg, y= Period, col=Power.avg.pval), linewidth=0.8) +
  xlim(0, 1) + 
  scale_color_gradient(low="#4AC0AD", high="black", breaks= c(0.05, 1), labels= c("≤ 0.05", "> 0.05"), guide="legend") +
  labs(x= "Average Wavelet Power", colour= "P-Value") +
  facet_grid(rows=vars(Temp_C), cols = vars(PulseSpace_s)) +
  theme_linedraw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

```{r}
Cr.TempDiff_C.avg <- plot.grid.data(CrWavelets) %>%
  mutate(Temp_C = factor(Temp_C, levels = c("24C","20C","16C", "12C"))) %>%
  mutate(Power.avg.pval = ifelse(Power.avg.pval <= 0.05, 0, 1))

Cr.TempDiff_C.avg %>%
  ggplot()+ 
  geom_path(aes(x= Power.avg, y= Period, col=Power.avg.pval), linewidth=0.8) +
  xlim(0, 1) + 
  scale_color_gradient(low="#4AC0AD", high="black", breaks= c(0.05, 1), labels= c("≤ 0.05", "> 0.05"), guide="legend") +
  labs(x= "Average Wavelet Power", colour= "P-Value") +
  facet_grid(rows=vars(Temp_C), cols = vars(PulseSpace_s)) +
  theme_linedraw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

```{r}
Cv.TempDiff_C.avg <- plot.grid.data(CvWavelets) %>%
  mutate(Temp_C = factor(Temp_C, levels = c("22C","18C","14C", "10C"))) %>%
  mutate(Power.avg.pval = ifelse(Power.avg.pval <= 0.05, 0, 1))

Cv.TempDiff_C.avg %>%
  ggplot()+ 
  geom_path(aes(x= Power.avg, y= Period, col=Power.avg.pval), linewidth=0.8) +
  xlim(0, 1) + 
  scale_color_gradient(low="#4AC0AD", high="black", breaks= c(0.05, 1), labels= c("≤ 0.05", "> 0.05"), guide="legend") +
  labs(x= "Average Wavelet Power", colour= "P-Value") +
  facet_grid(rows=vars(Temp_C), cols = vars(PulseSpace_s)) +
  theme_linedraw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

```{r}
Tp.TempDiff_C.avg <- plot.grid.data(TpWavelets) %>%
  mutate(Temp_C = factor(Temp_C, levels = c("22C","18C","14C", "10C"))) %>%
  mutate(Power.avg.pval = ifelse(Power.avg.pval <= 0.05, 0, 1))

Tp.TempDiff_C.avg %>%
  ggplot()+ 
  geom_path(aes(x= Power.avg, y= Period, col=Power.avg.pval), linewidth=0.8) +
  xlim(0, 1) + 
  scale_color_gradient(low="#4AC0AD", high="black", breaks= c(0.05, 1), labels= c("≤ 0.05", "> 0.05"), guide="legend") +
  labs(x= "Average Wavelet Power", colour= "P-Value") +
  facet_grid(rows=vars(Temp_C), cols = vars(PulseSpace_s)) +
  theme_linedraw() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

### Damping Across Taxa

```{r}
sstate_damping <- readRDS("~/LowLightPhotosynth/Data/ProcessedData/LOW_SState_Damping.Rds")

frag <- sstate_damping %>%
  filter(Species == "Fragilariopsis_cylindrus")

frag$PulseSpace_s <- as.numeric(frag$PulseSpace_s)
frag$TempDiff_C <- as.numeric(frag$TempDiff_C)
```

```{r}
library(plotly)
library(reshape2)
data.loess <- loess(DampingIndex ~ TempDiff_C * PulseSpace_s, data = sstate_damping, subset= Species == "Fragilariopsis_cylindrus")
xgrid <-  seq(0, max(frag$TempDiff_C), 0.3)
ygrid <-  seq(min(frag$PulseSpace_s), max(frag$PulseSpace_s), 0.3)
data.fit <-  expand.grid(TempDiff_C = xgrid, PulseSpace_s = ygrid)
mtrx3d <-  predict(data.loess, newdata = data.fit)

mtrx.melt <- melt(mtrx3d, id.vars = c('TempDiff_C', 'PulseSpace_s'), measure.vars = 'DampingIndex')
names(mtrx.melt) <- c('TempDiff_C', 'PulseSpace_s', 'DampingIndex')

# Return data to numeric form
mtrx.melt$TempDiff_C <- as.numeric(str_sub(mtrx.melt$TempDiff_C, str_locate(mtrx.melt$TempDiff_C, '=')[1,1] + 1))
mtrx.melt$PulseSpace_s <-  as.numeric(str_sub(mtrx.melt$PulseSpace_s, str_locate(mtrx.melt$PulseSpace_s, '=')[1,1] + 1))

fig <- plot_ly(mtrx.melt, x = ~TempDiff_C, y = ~PulseSpace_s, z = ~DampingIndex, type = "contour",
             width = 600, height = 500)

fig

```



```{r}
sstate_damping %>% 
  filter(Species %in% c("Fragilariopsis_cylindrus", "Thalassiosira_pseudonana")) %>%
  ggplot() + 
  geom_tile(aes(x = TempDiff_C, y = PulseSpace_s, fill = DampingIndex)) +  
  viridis::scale_fill_viridis(option="mako", na.value="white") + 
  facet_wrap(vars(Species))+ #, labeller = labeller(Species=species.labs)) +  
  theme_linedraw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```



```{r}
sstate_damping$PulseSpace_s <- factor(sstate_damping$PulseSpace_s, levels = c("1","2","4","8","16"))
sstate_damping$Temp_C <- factor(sstate_damping$Temp_C, levels = c("0","2","4","6","8","10","12","14","16","18","20","22","24"))

species.labs <- c("Chlamydomonas ICEMDV", "Chlamydomonas malina", "Chlamydomonas priscuii", "Chlamydomonas reinhardtii", "Chlorella vulgaris", "Fragilariopsis cylindrus", "Thalassiosira pseudonana")
names(species.labs) <- c("Chlamydomonas_ICEMDV", "Chlamydomonas_malina", "Chlamydomonas_priscuii", "Chlamydomonas_reinhardtii", "Chlorella_vulgaris", "Fragilariopsis_cylindrus", "Thalassiosira_pseudonana")

# sstate_damping <- sstate_damping %>%
#   mutate(DampingIndex = ifelse(DampingIndex == 0, NA, DampingIndex))
```


```{r heat map}
sstate_damping %>% 
  ggplot() + 
  geom_tile(aes(x = Temp_C, y = PulseSpace_s, fill = DampingIndex)) +
  viridis::scale_fill_viridis(option="mako", na.value="white") + 
  labs(x= "Temperature (°C)", y= "Flash Spacing (s)", fill= "Damping Index") + 
  facet_wrap(vars(Species), scales = "free", labeller = labeller(Species=species.labs)) +  
  theme_linedraw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```




