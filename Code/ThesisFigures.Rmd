---
title: "Thesis Figures"
author: "Natasha Ryan"
output: 
  html_document: default
  word_document: default
editor_options: 
  chunk_output_type: inline
---

This RMD imports data to generate figures for Natasha Ryan's undergraduate honours thesis at Mount Allison University. 

```{r}
library(tidyverse)
```


# Methods 

```{r }
Fc_data <- readRDS("../Data/CleanData/LOW_Fragilariopsis_cylindrus_G0_SolFitsTrim.Rds")

s.col <- c("#003D4F","#375D97","#3397A6","#9FD4C2")

Fc_data %>%
  filter(Filename == "20230926_SeGu1001_0C_1s") %>%
  filter(Flashnumber <= 13) %>%
  ggplot() +
  geom_point(aes(x=Flashnumber, y=FvFmrunnorm, col=as.factor(SState))) +
  scale_color_manual(values = s.col) +
  #scale_y_continuous(limits=c(0.5, 1.1)) +
  scale_x_continuous(breaks=c(4,8,12))+
  labs(x= "Flash Number", y= "Normalized Chlorophyll Fluorescence") +
  theme_bw() +
  theme(legend.position = "none", text = element_text(family = "Palatino"), 
        axis.text=element_text(size=16), axis.title=element_text(size=14.8),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```


# Results

### Representative Fluorescence Oscillations

```{r warning=FALSE}
Fc_data %>%
  filter(YYYYMMDD == "2023-09-27") %>%
  filter(Temp_C %in% c(0,10)) %>%
  filter(PulseSpace_s %in% c(1,4,16)) %>%
  ggplot() +
  geom_point(aes(x=Flashnumber, y=FvFmrunnorm, col=as.factor(SState))) +
  scale_color_manual(values = s.col) +
  labs(x= "Flash Number", y= "Normalized Chlorophyll Fluorescence", col= "S-State") +
  facet_grid(rows=vars(PulseSpace_s), cols=vars(Temp_C)) +
  scale_y_continuous(sec.axis=sec_axis(~ . , name = sym("Flash Spacing (s)"),breaks = NULL,labels = NULL)) +
  scale_x_continuous(breaks=c(4,8,12,16,20,24,28,32),
       sec.axis=sec_axis(~ . , name = sym("Measurement Temperature (°C)"), breaks = NULL, labels = NULL)) +
  theme_bw() +
  theme(text = element_text(family = "Times New Roman"), 
        axis.text=element_text(size=11), axis.title=element_text(size=13),
        legend.text=element_text(size=11), legend.title=element_text(size=13),
        strip.background = element_rect(colour="black", fill=NA),
        strip.text = element_text(size=11), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())

# ggsave("representativeoscillations.png", width = 8, height = 5, dpi = 900,
#       plot=last_plot(),
#       path="../Output")
```



### FFT




### Wavelet Power


```{r function}
plot.wt.grid <- function(wavelets) {
  result_list <- lapply(names(wavelets), function(condition_name) {
    condition <- wavelets[[condition_name]]
    Power.avg <- condition$Power.avg
    Power.avg.pval <- condition$Power.avg.pval
    Period <- condition$Period
    Condition <- rep(condition_name, length(Power.avg))  # Repeat condition name for each row
    df <- data.frame(Power.avg, Power.avg.pval, Period, Condition) %>%
      separate(Condition, into = c("Temp_C", "PulseSpace_s"), sep = "_") %>%
      mutate(PulseSpace_s = str_remove(PulseSpace_s, "s"),
             PulseSpace_s = factor(PulseSpace_s, levels = c("1","2","4","8","16"))) %>%
      mutate(Temp_C = str_remove(Temp_C, "C"),
             Temp_C = factor(Temp_C, levels = 
                               c("0","2","4","6","8","10","12","14","16","18","20","22","24"))) %>%
      mutate(Power.avg.pval = ifelse(Power.avg.pval <= 0.05, 0, 1))
    
     return(df)
  })

  result_df <- bind_rows(result_list)  # Combine all data frames and add a column for element names
  
  plot <- result_df %>%
    ggplot()+ 
    geom_path(aes(x= Power.avg, y= Period, col=Power.avg.pval), linewidth=0.8) +
    scale_color_gradient(low="#4AC0AD", high="black", breaks= c(0.05, 1), 
                         labels= c("≤ 0.05", "> 0.05"), guide="legend") +
    labs(x= "Average Wavelet Power", colour= "P-Value") +
    facet_grid(rows=vars(PulseSpace_s), cols = vars(Temp_C)) +
    scale_y_continuous(sec.axis=sec_axis(~ . , name = sym("Flash Spacing (s)"),
                                         breaks = NULL,labels = NULL)) +
    scale_x_continuous(limits= c(0:1), breaks=c(0, 0.5, 1), 
        sec.axis=sec_axis(~ . , name = sym("Measurement Temperature (°C)"), breaks = NULL, labels = NULL)) +
    theme_bw() +
    theme(text = element_text(family = "Times New Roman"), 
        axis.text=element_text(size=11), axis.title=element_text(size=13),
        legend.text=element_text(size=11), legend.title=element_text(size=13),
        strip.background = element_rect(colour="black", fill=NA),
        strip.text = element_text(size=11), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank())
    
  return(plot)
}
```


```{r Periodicity Test, warning=FALSE}
plot.wt.grid(FcG0_wavelets)
plot.wt.grid(FcG6_wavelets)
plot.wt.grid(Ci_wavelets)
plot.wt.grid(Cm_wavelets)
plot.wt.grid(Cp_wavelets)
plot.wt.grid(Cr_wavelets)
plot.wt.grid(Cv_wavelets)
plot.wt.grid(Tp_wavelets)
```


### Damping Across Taxa

```{r}
sstate_damping <- readRDS("~/LowLightPhotosynth/Data/ProcessedData/LOW_SState_Damping.Rds")

sstate_damping$PulseSpace_s <- as.numeric(sstate_damping$PulseSpace_s)
sstate_damping$TempDiff_C <- as.numeric(sstate_damping$TempDiff_C)
```


```{r}
library(plotly)
library(reshape2)
library(tidyverse)
frag <- FcG0_damping
frag$TempDiff_C <- as.numeric(frag$TempDiff_C)
frag$Light_Level <- as.numeric(frag$Light_Level)


frag.data.loess <- loess(DampingIndex ~ TempDiff_C * Light_Level, data = frag)
frag.xgrid <-  seq(0, 10, 0.3)
frag.ygrid <-  seq(min(frag$Light_Level), max(frag$Light_Level), 0.03)
frag.data.fit <-  expand.grid(TempDiff_C = frag.xgrid, Light_Level = frag.ygrid)
frag.mtrx3d <-  predict(frag.data.loess, newdata = frag.data.fit)

frag.mtrx.melt <- melt(frag.mtrx3d, id.vars = c('TempDiff_C', 'Light_Level'), measure.vars = 'DampingIndex')
names(frag.mtrx.melt) <- c('TempDiff_C', 'Light_Level', 'DampingIndex')

# Return data to numeric form
frag.mtrx.melt$TempDiff_C <- as.numeric(str_sub(frag.mtrx.melt$TempDiff_C, str_locate(frag.mtrx.melt$TempDiff_C, '=')[1,1] + 1))
frag.mtrx.melt$Light_Level <-  as.numeric(str_sub(frag.mtrx.melt$Light_Level, str_locate(frag.mtrx.melt$Light_Level, '=')[1,1] + 1))

frag.fig <- plot_ly(frag.mtrx.melt, x = ~TempDiff_C, y = ~Light_Level, z = ~DampingIndex, type = "contour",
                    contours = list(coloring = 'heatmap'),
             width = 600, height = 500)

frag.fig
```



```{r}
tpseu <- sstate_damping %>%
  filter(Species == "Thalassiosira_pseudonana")


tpseu.data.loess <- loess(DampingIndex ~ TempDiff_C * PulseSpace_s, data = tpseu)
tpseu.xgrid <-  seq(-6, 10, 0.3)
tpseu.ygrid <-  seq(1, 16, 0.3)
tpseu.data.fit <-  expand.grid(TempDiff_C = tpseu.xgrid, PulseSpace_s = tpseu.ygrid)
tpseu.mtrx3d <-  predict(tpseu.data.loess, newdata = tpseu.data.fit)

tpseu.mtrx.melt <- melt(tpseu.mtrx3d, id.vars = c('TempDiff_C', 'PulseSpace_s'), measure.vars = 'DampingIndex')
names(tpseu.mtrx.melt) <- c('TempDiff_C', 'PulseSpace_s', 'DampingIndex')

# Return data to numeric form
tpseu.mtrx.melt$TempDiff_C <- as.numeric(str_sub(tpseu.mtrx.melt$TempDiff_C, str_locate(tpseu.mtrx.melt$TempDiff_C, '=')[1,1] + 1))
tpseu.mtrx.melt$PulseSpace_s <-  as.numeric(str_sub(tpseu.mtrx.melt$PulseSpace_s, str_locate(tpseu.mtrx.melt$PulseSpace_s, '=')[1,1] + 1))

tpseu.fig <- plot_ly(tpseu.mtrx.melt, x = ~TempDiff_C, y = ~PulseSpace_s, z = ~DampingIndex, type = "contour",
             width = 600, height = 500)

tpseu.fig
```


```{r}
ice <- sstate_damping %>%
  filter(Species == "Chlamydomonas_ICEMDV")

ice.data.loess <- loess(DampingIndex ~ TempDiff_C * PulseSpace_s, data = ice)
ice.xgrid <-  seq(0, 8, 0.2)
ice.ygrid <-  seq(1, 16, 0.2)
ice.data.fit <-  expand.grid(TempDiff_C = ice.xgrid, PulseSpace_s = ice.ygrid)
ice.mtrx3d <-  predict(ice.data.loess, newdata = ice.data.fit)

ice.mtrx.melt <- melt(ice.mtrx3d, id.vars = c('TempDiff_C', 'PulseSpace_s'), measure.vars = 'DampingIndex')
names(ice.mtrx.melt) <- c('TempDiff_C', 'PulseSpace_s', 'DampingIndex')

# Return data to numeric form
ice.mtrx.melt$TempDiff_C <- as.numeric(str_sub(ice.mtrx.melt$TempDiff_C, str_locate(ice.mtrx.melt$TempDiff_C, '=')[1,1] + 1))
ice.mtrx.melt$PulseSpace_s <-  as.numeric(str_sub(ice.mtrx.melt$PulseSpace_s, str_locate(ice.mtrx.melt$PulseSpace_s, '=')[1,1] + 1))

ice.fig <- plot_ly(ice.mtrx.melt, x = ~TempDiff_C, y = ~PulseSpace_s, z = ~DampingIndex, type = "contour",
             width = 600, height = 500)

ice.fig
```

```{r}
mal <- sstate_damping %>%
  filter(Species == "Chlamydomonas_malina")

mal.data.loess <- loess(DampingIndex ~ TempDiff_C * PulseSpace_s, data = mal)
mal.xgrid <-  seq(0, 8, 0.2)
mal.ygrid <-  seq(1, 16, 0.2)
mal.data.fit <-  expand.grid(TempDiff_C = mal.xgrid, PulseSpace_s = mal.ygrid)
mal.mtrx3d <-  predict(mal.data.loess, newdata = mal.data.fit)

mal.mtrx.melt <- melt(mal.mtrx3d, id.vars = c('TempDiff_C', 'PulseSpace_s'), measure.vars = 'DampingIndex')
names(mal.mtrx.melt) <- c('TempDiff_C', 'PulseSpace_s', 'DampingIndex')

# Return data to numeric form
mal.mtrx.melt$TempDiff_C <- as.numeric(str_sub(mal.mtrx.melt$TempDiff_C, str_locate(mal.mtrx.melt$TempDiff_C, '=')[1,1] + 1))
mal.mtrx.melt$PulseSpace_s <-  as.numeric(str_sub(mal.mtrx.melt$PulseSpace_s, str_locate(mal.mtrx.melt$PulseSpace_s, '=')[1,1] + 1))

mal.fig <- plot_ly(mal.mtrx.melt, x = ~TempDiff_C, y = ~PulseSpace_s, z = ~DampingIndex, type = "contour",
             width = 600, height = 500)

mal.fig
```

```{r}
pris <- sstate_damping %>%
  filter(Species == "Chlamydomonas_priscuii")

pris.data.loess <- loess(DampingIndex ~ TempDiff_C * PulseSpace_s, data = pris)
pris.xgrid <-  seq(0, 8, 0.2)
pris.ygrid <-  seq(1, 16, 0.2)
pris.data.fit <-  expand.grid(TempDiff_C = pris.xgrid, PulseSpace_s = pris.ygrid)
pris.mtrx3d <-  predict(pris.data.loess, newdata = pris.data.fit)

pris.mtrx.melt <- melt(pris.mtrx3d, id.vars = c('TempDiff_C', 'PulseSpace_s'), measure.vars = 'DampingIndex')
names(pris.mtrx.melt) <- c('TempDiff_C', 'PulseSpace_s', 'DampingIndex')

# Return data to numeric form
pris.mtrx.melt$TempDiff_C <- as.numeric(str_sub(pris.mtrx.melt$TempDiff_C, str_locate(pris.mtrx.melt$TempDiff_C, '=')[1,1] + 1))
pris.mtrx.melt$PulseSpace_s <-  as.numeric(str_sub(pris.mtrx.melt$PulseSpace_s, str_locate(pris.mtrx.melt$PulseSpace_s, '=')[1,1] + 1))

pris.fig <- plot_ly(pris.mtrx.melt, x = ~TempDiff_C, y = ~PulseSpace_s, z = ~DampingIndex, type = "contour",
             width = 600, height = 500)

pris.fig
```


```{r}
rein <- sstate_damping %>%
  filter(Species == "Chlamydomonas_reinhardtii")

rein.data.loess <- loess(DampingIndex ~ TempDiff_C * PulseSpace_s, data = rein)
rein.xgrid <-  seq(-12, 0, 0.2)
rein.ygrid <-  seq(1, 16, 0.2)
rein.data.fit <-  expand.grid(TempDiff_C = rein.xgrid, PulseSpace_s = rein.ygrid)
rein.mtrx3d <-  predict(rein.data.loess, newdata = rein.data.fit)

rein.mtrx.melt <- melt(rein.mtrx3d, id.vars = c('TempDiff_C', 'PulseSpace_s'), measure.vars = 'DampingIndex')
names(rein.mtrx.melt) <- c('TempDiff_C', 'PulseSpace_s', 'DampingIndex')

# Return data to numeric form
rein.mtrx.melt$TempDiff_C <- as.numeric(str_sub(rein.mtrx.melt$TempDiff_C, str_locate(rein.mtrx.melt$TempDiff_C, '=')[1,1] + 1))
rein.mtrx.melt$PulseSpace_s <-  as.numeric(str_sub(rein.mtrx.melt$PulseSpace_s, str_locate(rein.mtrx.melt$PulseSpace_s, '=')[1,1] + 1))

rein.fig <- plot_ly(rein.mtrx.melt, x = ~TempDiff_C, y = ~PulseSpace_s, z = ~DampingIndex, type = "contour",
             width = 600, height = 500)

rein.fig
```


```{r}
vulg <- sstate_damping %>%
  filter(Species == "Chlorella_vulgaris")

vulg.data.loess <- loess(DampingIndex ~ TempDiff_C * PulseSpace_s, data = vulg)
vulg.xgrid <-  seq(-12, 0, 0.2)
vulg.ygrid <-  seq(1, 16, 0.2)
vulg.data.fit <-  expand.grid(TempDiff_C = vulg.xgrid, PulseSpace_s = vulg.ygrid)
vulg.mtrx3d <-  predict(vulg.data.loess, newdata = vulg.data.fit)

vulg.mtrx.melt <- melt(vulg.mtrx3d, id.vars = c('TempDiff_C', 'PulseSpace_s'), measure.vars = 'DampingIndex')
names(vulg.mtrx.melt) <- c('TempDiff_C', 'PulseSpace_s', 'DampingIndex')

# Return data to numeric form
vulg.mtrx.melt$TempDiff_C <- as.numeric(str_sub(vulg.mtrx.melt$TempDiff_C, str_locate(vulg.mtrx.melt$TempDiff_C, '=')[1,1] + 1))
vulg.mtrx.melt$PulseSpace_s <-  as.numeric(str_sub(vulg.mtrx.melt$PulseSpace_s, str_locate(vulg.mtrx.melt$PulseSpace_s, '=')[1,1] + 1))

vulg.fig <- plot_ly(vulg.mtrx.melt, x = ~TempDiff_C, y = ~PulseSpace_s, z = ~DampingIndex, type = "contour",
             width = 600, height = 500)

vulg.fig
```


```{r}
sstate_damping %>% 
  filter(Species %in% c("Fragilariopsis_cylindrus", "Thalassiosira_pseudonana")) %>%
  ggplot() + 
  geom_tile(aes(x = TempDiff_C, y = PulseSpace_s, fill = DampingIndex)) +  
  viridis::scale_fill_viridis(option="mako", na.value="white") + 
  facet_wrap(vars(Species))+ #, labeller = labeller(Species=species.labs)) +  
  theme_linedraw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```



```{r}
sstate_damping$PulseSpace_s <- factor(sstate_damping$PulseSpace_s, levels = c("1","2","4","8","16"))
sstate_damping$Temp_C <- factor(sstate_damping$Temp_C, levels = c("0","2","4","6","8","10","12","14","16","18","20","22","24"))

species.labs <- c("Chlamydomonas ICEMDV", "Chlamydomonas malina", "Chlamydomonas priscuii", "Chlamydomonas reinhardtii", "Chlorella vulgaris", "Fragilariopsis cylindrus", "Thalassiosira pseudonana")
names(species.labs) <- c("Chlamydomonas_ICEMDV", "Chlamydomonas_malina", "Chlamydomonas_priscuii", "Chlamydomonas_reinhardtii", "Chlorella_vulgaris", "Fragilariopsis_cylindrus", "Thalassiosira_pseudonana")

# sstate_damping <- sstate_damping %>%
#   mutate(DampingIndex = ifelse(DampingIndex == 0, NA, DampingIndex))
```


```{r heat map}
sstate_damping %>% 
  ggplot() + 
  geom_tile(aes(x = Temp_C, y = PulseSpace_s, fill = DampingIndex)) +
  viridis::scale_fill_viridis(option="mako", na.value="white") + 
  labs(x= "Temperature (°C)", y= "Flash Spacing (s)", fill= "Damping Index") + 
  facet_wrap(vars(Species), scales = "free", labeller = labeller(Species=species.labs)) +  
  theme_linedraw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```




