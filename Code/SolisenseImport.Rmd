---
title: "SolisenseImport"
author:
- Natasha Ryan
- Maximilian Berthold
- Douglas A. Campbell
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    code_folding: hide
    keep_md: yes
    fig_caption: yes
    toc: TRUE
    toc_float: TRUE   
csl: plos-one.csl
editor_options: 
  chunk_output_type: inline
---

*Some of the code used to create this R Notebook was refurbished from "PlateAbImport.Rmd" written by Maximilian Berthold, Douglas A. Campbell, Melissa L. Rioux, Sarah J Gore, and Alyson MacCormack.*

# To Do
FFT analysis of FvFm vs Flashnumber     
    Data - Raw Data - NoDecay - Fit - files from 20230314       
Small dataset: 32 flashes at each of 0.5, 1, 2, 4, and 8 second intervals done at 10 and 18°C   

Issue: to generate poster references, bib file had to be in poster folder   
    Add references somehow? ".." path?        
    
Add secondary y-axis for flash spacing    

Choose (ask Campbell)   
- Facet by time or temperature    
    maybe choose to illustrate whichever shows a more significant difference (seems to be spacing)    
- Graph/analyze Fm or FvFm    
    which is better     

```{r load libraries}
library(tidyverse)
library(lubridate)
library(googlesheets4)
library(googledrive)
library(zoo)
```


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Output/')
```

# Set Project Variables
```{r set project variables}
Project <- "LOW"
TargetTaxa <- "Chlamy"
DataOut <- file.path("..","Data", "CleanData")
CalibData <- file.path("..","Data", "CalibData")

#ChlDataURL <- "https://docs.google.com/spreadsheets/d/1K4ibFMAjxHUszMHw-beBns0cqNqF2G7nZDF9Drm8MAQ/edit#gid=0"

#Temporary RunDate during auditing
#RunDate <- "Refit"

#DataIn <- file.path("..","Data", "RawData","Fit", fsep = .Platform$file.sep)
DataIn <- file.path("..","Data", "RawData", TargetTaxa, fsep = .Platform$file.sep)
DataRefDecay <- file.path("..","Data", "RawData",TargetTaxa, "DecayRef", fsep = .Platform$file.sep)
DataRLC <- file.path("..","Data", "RawData",TargetTaxa, "RLC", fsep = .Platform$file.sep)

FileID <- "fit"

FileEncode <- "UTF-8"
#guess_encoding says 'ASCII"

Delimiter <- ","

HeaderRows <- 0

```

```{r conversions}
us_s = 1000000
photons_umol = 6.022E17
A2_m2 = 1E20
```

```{r read ActPAR calibration files}
#ActPARCal <- readRDS("~/Dropbox/CampbellLabProtocols/ChlorophyllFluorescence/SolisenseInformation/SolisenseInformation_DCCalibParam.Rds")

ActPARCrossCal <- list.files(path = CalibData, full.names = TRUE) %>%
     map_df(~readRDS(file  = .))

#intercept set to 0 in lm in SolisenseInformation.Rproj/SolisenseCalibCompare.Rmd
ActPARCrossCal <- ActPARCrossCal |>
  rename(#Intercept = `estimate_(Intercept)`,
         Slope = `estimate_LIFT_Gen_Developer.cal`,
         #Intercept_SE = `std.error_(Intercept)`,
         Slope_SE = `std.error_LIFT_Gen_Developer.cal`)
```

```{r read ChlData}
gs4_deauth()

ChlData <- read_sheet(ChlDataURL)


```


```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c("darkblue", "dodgerblue", "darkgreen", "yellowgreen",  "darkorange")


names(Colours_nm) <- Wavelengths_nm
Colours_nm

```


```{r list PSI files for file import}
SolisenseFiles <- list.files(path = DataIn, pattern = FileID, full.names = TRUE)
SolisenseFiles

#test for duplicate file names
unique(duplicated(SolisenseFiles))
```

```{r data read adds filename and cdate, warning=FALSE, message=FALSE, echo=FALSE}
#design choice 2 file reading functions or add a filetype variable to a single function
#stringsAsFactors =FALSE somewhere? 

read.delim_plus <- function(flnm, file_encode, delimiter, header_rows){read.delim(flnm, fileEncoding = file_encode, sep = delimiter,  skip = header_rows, row.names = NULL) %>% mutate(Filename = flnm)
}

```

# Create Data Frame 
purrr::map to read all files
```{r read Solisense files}
SolFits <- SolisenseFiles %>%
  map_df(~read.delim_plus(flnm =., file_encode = FileEncode, delimiter = Delimiter, header_rows = HeaderRows))
```

# Odd issue in WithDecay files, with ChiSq appearing a second time after QARredMax column, offsetting column headers from proper data columns
```{r tidy SolFitsTrim ND}
#for NoDecayDataset
SolFitsTrim <- SolFits |>
  filter(!grepl("----", DATE)) |> # remove rows with "----" 
  select(-c("RFID_User_Data", "Barcode_Data","PIF", "LEDSel", "Dur.Wat", "Lon", "Lat", "GPS_stat","X" ))  # remove superfluous columns

#OldNames <- c("Chisq", "Fo", "Fm","Fv.Fm", "Sig", "p","Alp1QA","Tau1QA","Alp2QA","Tau2QA","Alp3QA")
#NewNames <- c("Fo", "Fm","Fv.Fm", "Sig", "p","Alp1QA","Tau1QA","Alp2QA","Tau2QA","Alp3QA","Tau3QANew")

head(SolFitsTrim)

SolFitsTrim <- SolFitsTrim |>
  #rename_with(~ NewNames[which(OldNames == .x)], .cols = OldNames) |>
  #select(-c(Tau3QA)) |>
  #rename(Tau3QA = Tau3QANew) |>
  mutate(Filename = str_remove(string = Filename, pattern = "_fit.csv")) |>
  #mutate(Filename = str_remove(string = Filename, pattern = "../Data/RawData/NoDecay/")) %>%
    mutate(Filename = str_remove(string = Filename, pattern = "../Data/RawData/")) |>
 # mutate(Filename = str_remove(string = Filename, pattern = "LOW_")) %>%
  separate(Filename, into=c("Species", "YYYYMMDD", "CultureID", "Temp_C", "PulseSpace_s"), sep = "([\\/\\_])", remove = FALSE) %>%
  mutate(YYYYMMDD = lubridate::ymd(YYYYMMDD),
          TIME = as.character(TIME)) %>%
   rename(ObsDate = DATE,
         ObsTime = TIME,
         FvFm = "Fv.Fm") |>
  type_convert() |>
  mutate(PulseSpace_s = str_remove(PulseSpace_s, "s")) |>  #s vs S
  filter(PulseSpace_s %in% c(1, 2, 4, 8, 16)) |>  #remove rows with other PulseSpace_s
 # mutate(PulseSpace_s = if_else(PulseSpace_s %in% c("05"), "0.5", PulseSpace_s))
  mutate(PulseSpace_s = as.numeric(PulseSpace_s)) |>
  mutate(ObsDateTime = lubridate::ymd_hms(paste(ObsDate, ObsTime))) %>%
  relocate(ObsDateTime, .after = ObsTime) %>%
  relocate(CultureID, .before = ObsDate) |>
  type_convert()


#normalize values to final stretch of 10 values from 'randomized' PSII pool
SolFitsTrim <-SolFitsTrim %>%
  group_by(Filename) %>%
  arrange(ObsTime) |>
  mutate(Sigrunnorm =  Sig/mean(Sig[(length(Sig) - 10):length(Sig)], na.rm = TRUE),
         Forunnorm = Fo/mean(Fo[(length(Fo) - 10):length(Fo)], na.rm = TRUE),
         Fmrunnorm = Fm/mean(Fm[(length(Fm) - 10):length(Fm)], na.rm = TRUE),
         FvFmrunnorm = FvFm/mean(FvFm[(length(FvFm) - 10):length(FvFm)], na.rm = TRUE)) |>
  mutate(Flashnumber = row_number()) %>%
  mutate(Flashnumber2 = rank(ObsTime)) |>
  relocate(Flashnumber, .before=p) %>%
  mutate(Etime_s = (as.numeric(Time__mSec) - min(as.numeric(Time__mSec), na.rm = TRUE))/1000, .before=Flashnumber) %>%
  ungroup()

head(SolFitsTrim)
```


```{r fix column names}
#only use this chunk if analyzing data from Data-RawData-WithDecay-Fit
#create new data frame, had to remove extra column
#SolFits2 <- SolFits[-32] 
#assign correct names
#Fixnames <- colnames(SolFits)[22:32]
#rename columns 
#colnames(SolFits2)[21:31] <- c(Fixnames)
```

```{r tidy SolFitsTrim WD}
# for WithDecay Fit Dataset

#Think of better ways to do this
#Careful about RunDate, which is the label of a RunDate sub-folder.
#SolFitsTrim <- SolFits %>% 
  #filter(!grepl("----", DATE)) %>% # remove rows with "----"
 # select(-c("RFID_User_Data", "Barcode_Data","PIF", "Lon", "Lat", "GPS_stat","X")) %>% # remove superfluous columns
  #mutate(Filename = str_remove(string = Filename, pattern = "_fit.csv")) %>%
  #mutate(Filename = str_remove(string = Filename, pattern = "../Data/RawData/NoDecay/Fit/")) %>%
  #separate(Filename, into=c("YYYYMMDD", "CultureID", "Temp_C", "PulseSpace_s"), sep = "([\\/\\_])", remove = FALSE) %>%
  #separate(Filename, into = c("Project", "YYYYMMDD", "CultureID","Temp_C", "PulseSpace_s","Ex_WL", "Flashpower"), sep = "([\\/\\_])", remove = FALSE) %>%
 # mutate(YYYYMMDD = lubridate::ymd(YYYYMMDD),
         # TIME = as.character(TIME)) %>% #time-column may be read in as factor, and as.character changes it to numeric; using lubdridate::hms would only change the format to 13H 4M 2S but does not work later to merge into one DateTime-column
  #rename(ObsDate = DATE,
        # ObsTime = TIME,
       #  FvFm = "Fv.Fm") %>%
 # mutate(Ex_WL = as.factor(as.numeric(Ex_WL))) %>%
  #mutate(FvFm = as.numeric(as.character(FvFm)),
        # nm445 = as.numeric(as.character(Light_1)),
        # nm470 = as.numeric(as.character(Light_2)),
        # nm505 = as.numeric(as.character(Light_3)),
       # nm535 = as.numeric(as.character(Light_4)),
       #  nm590 = as.numeric(as.character(Light_5)),
        # IR = as.numeric(as.character(Light_6))) %>%
 # mutate(ObsDateTime = lubridate::ymd_hms(paste(ObsDate, ObsTime))) %>%
 # relocate(ObsDateTime, .after = ObsTime) %>%
 # relocate(CultureID, .before = ObsDate)

#SolFitsTrim <-SolFitsTrim %>%
#  group_by(Filename) %>%
 # mutate(Flashnumber = row_number()) %>%
 # relocate(Flashnumber, .before=p) %>%
  #mutate(Etime_s = (as.numeric(Time__mSec) - min(as.numeric(Time__mSec), na.rm = TRUE))/1000, .before=Flashnumber) %>%
  #ungroup()
```

# Basic plots

Fm vs Flashnumber line; facet by temp 
```{r Fm vs Flashnumber(by T)}
#facetbytemp
SolFitsTrim %>%
  ggplot()+
  geom_line(aes(x=Flashnumber, y=FvFm, colour = as.factor(PulseSpace_s))) +
  facet_grid(rows = vars(Temp_C, ObsDate), cols = vars(CultureID)) +
  labs(title = TargetTaxa) +
  theme_bw()

SolFitsTrim %>%
  ggplot()+
  geom_line(aes(x=Flashnumber, y=Flashnumber2, colour = as.factor(PulseSpace_s))) +
  facet_grid(rows = vars(Temp_C)) +
  labs(title = TargetTaxa) +
  theme_bw()
```

Fmrunnorm vs Flashnumber line; facet by flash spacing
```{r Fm vs Flashnumber(by S)}
#facetbyspacing
SolFitsTrim %>%
  ggplot()+
  geom_line(aes(x=ObsTime, y= Fmrunnorm)) +
  facet_grid(rows = vars(PulseSpace_s), cols = vars(Temp_C)) +
  labs(title = TargetTaxa) +
  theme_bw()
```


```{r save SolFitsTrim data}
saveRDS(SolFitsTrim, file.path(DataOut, paste(Project,  TargetTaxa, "SolFitsTrim.Rds", sep = "_"), fsep = .Platform$file.sep))
```



**Very rough** results:   
At **10c**        
Flash spacing- Very approximate # of flashes
0.5s-18   
1s-14   
1s-14   
4s-12   
8s-8    

At 10c, maintains periodicity longest at 0.5, followed by 1&2, then 4, and finally 8 damps out fastest        
    -as expected    

Maximum fluorescence is more variable   
    -why?   

At **18c**,   
Flash spacing- Very approximate # of flashes    
0.5s-16   
1s-12   
1s-10   
4s-8      
8s-8  


At 18c, same pattern in flash duration but overall shorter    

(line kinda shows it better than point, ask campbell?)    

Biggest gap between 10&18c is at 4s   
    -why?   

XXXXXX


**One to use** (according to Campbell):    
FvFm vs Flashnumber point 
```{r FvFm vs Flashnumber}
SolFitsDecayTrim %>%
  ggplot()+
  geom_point(aes(x=Flashnumber, y= FvFm, group=Temp_C, colour=Temp_C)) +
  facet_grid("PulseSpace_s") +
  scale_x_continuous(limits=c(0,16), breaks=seq(0,16,4)) +
  scale_colour_manual(values = c("lightsteelblue3","palevioletred4")) +
  theme(legend.position = "right") + xlab("Flash Number") + ylab("Maximum Quantum Yield of PSII") + 
  labs(colour="Temperature °C") +
  theme_bw(base_size = 14)

SolFitsDecayTrim %>%
  filter(PulseSpace_s %in% c(0.5, 8)) %>%
  ggplot()+
  geom_point(aes(x=Flashnumber, y=as.numeric(FvFm), group=Temp_C, colour=Temp_C)) +
  geom_line(aes(x=Flashnumber, y=as.numeric(FvFm), group=Temp_C, colour=Temp_C), linewidth = 0.2) +
  facet_grid(cols = vars(PulseSpace_s), rows = vars(Temp_C)) +
  scale_x_continuous(limits=c(0,16), breaks=seq(0,16,4)) +
  scale_colour_manual(values = c("lightsteelblue3","palevioletred4")) +
  theme(legend.position = "right") + xlab("Flash Number") + ylab("Maximum Quantum Yield of PSII") + 
  labs(colour="Temperature °C") +
  theme_bw(base_size = 14)

ggsave(
  "DiatomFlashCyclesDecay.png",
  plot = last_plot(),
  path = file.path("..", "Output")
)
```

FvFm vs Time point
```{r FvFm vs Time}
SolFitsDecayTrim %>%
  ggplot()+
  geom_point(aes(x=Etime_s, y=as.numeric(FvFm), group=Temp_C, colour=Temp_C)) +
  facet_grid("PulseSpace_s") +
  scale_colour_manual(values = c("steelblue2","maroon")) +
  theme(legend.position = "right") + xlab("Time Elapsed (s)") + ylab("Maximum Quantum Yield of PSII") + 
  labs(colour="Temperature °C") +
  theme_bw()
```

FvFm vs Flashnumber as line; facet by spacing
```{r FvFm vs Flashnumber (by S)}
#facet by spacing 
SolFitsDecayTrim %>%
  ggplot()+
  geom_line(aes(x=Flashnumber, y=as.numeric(FvFm), group=Temp_C, colour=Temp_C)) +
  facet_grid("PulseSpace_s") +
  scale_x_continuous(limits=c(0,20), breaks=seq(0,20,4)) +
  scale_colour_manual(values = c("steelblue2","maroon")) +
  theme(legend.position = "right") + xlab("Flash Number") + ylab("Maximum Quantum Yield of PSII") + 
  labs(colour="Temperature °C") +
  theme_bw()
```

FvFm vs Flashnumber as line; facet by temp
```{r FvFm vs Flashnumber (by t)}
# facet by temp
SolFitsDecayTrim %>%
  ggplot()+
  geom_line(aes(x=Flashnumber, y=as.numeric(FvFm), group=PulseSpace_s, colour=PulseSpace_s)) +
  facet_grid("Temp_C") +
  #scale_x_continuous(breaks=seq(0,32,4)) +
  scale_x_continuous(limits=c(0,16), breaks=seq(0,16,4)) +
  #scale_colour_manual(values = c("steelblue2","maroon")) +
  theme(legend.position = "right") + xlab("Flash Number") + ylab("Maximum Quantum Yield of PSII") + 
  labs(colour="Temperature °C") +
  theme_bw()
```

Within each temp, periodicity is weaker with inc pulse spacing    

Fm shows better periodicity than FvFm??   
    -maybe use that instead?    
But FvFm is closer between temps    

FvFm vs Flashnumber (by t) is kind of easier to read (ask Campbell)   
    
Try Fo: 
```{r Fo vs Flashnumber}
SolFitsDecayTrim %>%
  ggplot()+
  geom_line(aes(x=Flashnumber, y=as.numeric(Fo), group=Temp_C, colour=Temp_C)) +
  scale_x_continuous(limits=c(0,20), breaks=seq(0,20,4)) +
  facet_grid("PulseSpace_s") +
  theme_bw()
```

Fo = No. 

```{r save SolFitsTrim data}
saveRDS(SolFitsDecayTrim, file.path(DataOut, paste(Project, "SolFitsDecayTrim.Rds", sep = "_"), fsep = .Platform$file.sep))
```



FFT Transform         
@cernaFundamentalsFFTBasedSignal2000    
@natoFourierTransformTutorial2013   
@pengFastFourierTransform   
@ManipulatingTimeSeries   

# Bibliography



------------------------------ Other code from template---------------------------------
 
Add ActPARcorr with proper correction factors for TC and no TC
Intercepts for cross conversions set to 0.
Some smarter way to do this with map etc....

start chunk{r ActPARcorr}
SolFitsTrim <- SolFitsTrim |>
  mutate(nm445Corr = case_when(TempCont == "TC" ~ nm445 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr1_uE" & ActPARCrossCal$Models == "DCWaterJacketlm_tidy"],
                                 TempCont == "noTC" ~ nm445 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr1_uE" & ActPARCrossCal$Models == "DCCuvettelm_tidy"]),
         nm470Corr = case_when(TempCont == "TC" ~ nm470 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr2_uE" & ActPARCrossCal$Models == "DCWaterJacketlm_tidy"],
                                 TempCont == "noTC" ~ nm470 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr2_uE" & ActPARCrossCal$Models == "DCCuvettelm_tidy"]),
         nm505Corr = case_when(TempCont == "TC" ~ nm505 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr3_uE" & ActPARCrossCal$Models == "DCWaterJacketlm_tidy"],
                                 TempCont == "noTC" ~ nm505 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr3_uE" & ActPARCrossCal$Models == "DCCuvettelm_tidy"]),
           nm535Corr = case_when(TempCont == "TC" ~ nm535 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr4_uE" & ActPARCrossCal$Models == "DCWaterJacketlm_tidy"],
                                 TempCont == "noTC" ~ nm535 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr4_uE" & ActPARCrossCal$Models == "DCCuvettelm_tidy"]),
          nm590Corr = case_when(TempCont == "TC" ~ nm590 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr5_uE" & ActPARCrossCal$Models == "DCWaterJacketlm_tidy"],
                                 TempCont == "noTC" ~ nm590 * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "Pwr5_uE" & ActPARCrossCal$Models == "DCCuvettelm_tidy"]),
          IRCorr = case_when(TempCont == "TC" ~ IR * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "PwrIR_uE" & ActPARCrossCal$Models == "DCWaterJacketlm_tidy"],
                                 TempCont == "noTC" ~ IR * ActPARCrossCal$Slope[ActPARCrossCal$DCLamp == "PwrIR_uE" & ActPARCrossCal$Models == "DCCuvettelm_tidy"]))
                                 
SolFitsTrim <- SolFitsTrim %>%
  mutate(across(.cols = c(Light_1:ETR), .fns = as.numeric)) %>%
  mutate(ActPAR = nm445 + nm470 + nm505 + nm535 + nm590 + IR) |>
  mutate(ActPARCorr = nm445Corr + nm470Corr + nm505Corr + nm535Corr + nm590Corr + IRCorr)#better ways to do this?

SolFitsTrim[1,]

