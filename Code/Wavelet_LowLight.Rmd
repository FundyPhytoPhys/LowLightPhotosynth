---
title: "Wavelet Transformation"
author:
- Natasha Ryan
- Maximilian Berthold
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    code_folding: hide
    keep_md: yes
    fig_caption: yes
    toc: TRUE
    toc_float: TRUE   
csl: plos-one.csl
editor_options: 
  chunk_output_type: inline
---

# Introduction
This RMD computes a wave transformation and extracts the duration of fluorescence oscillations for the cleaned data generated from OttawaImport, TakuvikImport, and SackvilleImport. 

```{r load libraries}
library(tidyverse)
library(doBy)
library(WaveletComp)
```


# Set Project Variables
```{r set project variables}
Project <- "LOW"
DataIn <- file.path("..","Data", "CleanData")
CalibData <- file.path("..","Data", "CalibData")
DataOut <- file.path("..","Data", "ProcessedData")
FileID <- "SolFitsTrim"
siglvl <- 0.05 #specifies statistical significance level
Fc <- "Fragilariopsis_cylindrus"
Ci <- "Chlamydomonas_ICEMDV"
Cm <- "Chlamydomonas_malina"
Cp <- "Chlamydomonas_priscuii"
Cr <- "Chlamydomonas_reinhardtii"
Cv <- "Chlorella_vulgaris"
Tp <- "Thalassiosira_pseudonana"
```


```{r create functions}
#function for wavelet transformation 
wavelet <- function(data_list){
  wavelet_list <- lapply(data_list, function(data) {
    WaveletComp::analyze.wavelet(data, "FvFmrunnorm",
                                 method = "white.noise",
                                 loess.span = 0.75, 
                                 dt = 1, dj=1/500, 
                                 verbose = FALSE)
  })
return(wavelet_list)
}


#function for wavelet reconstruction, applies reconstruct() function from WaveletComp to all wavelets in a list
reconstructwave <- function(wavelet_list) {
  reconstructed_list <- lapply(wavelet_list, function(wave) {
    WaveletComp::reconstruct(wave, siglvl = siglvl, 
                             #plot.waves = TRUE, 
                             plot.rec = FALSE,
                             verbose = FALSE)
 })
  return(reconstructed_list) 
}


#function to extract the number of oscillating flashes from the reconstruction 
damping <- function(reconstructed) {
  result_list <- lapply(reconstructed, function(condition) {
    return(condition$series)
  }) #extract reconstructed wave data from 'reconstruct' objects 
  result_df <- data.frame(condition = character(0), damping.index = integer(0), stringsAsFactors = FALSE)
  
  for (condition in names(result_list)) {
    extract <- result_list[[condition]] 
    
    extract$difference <- c(NA, diff(extract$`FvFmrunnorm.r`)) #calculate difference in reconstructed FvFm values between successive rows 
    
    cycling.flashes <- which(extract$difference != 0) #extract row index where FvFm is oscillating
    
    damping.index <- max(cycling.flashes) #extract the highest row index (last row before FvFm damps)
    
    result_df <- rbind(result_df, data.frame(condition = condition, damping.index = damping.index))
  }
  return(result_df)
}

#plot of wavelet power averages across time, indicates which conditions show a significant periodicity of 4
plot.wt.avg <- function(wavelet_list) {
  
  for (condition in names(wavelet_list)) {
    extract <- wavelet_list[[condition]] 
    
    WaveletComp::wt.avg(extract, siglvl = siglvl,
      sigcol = "#71CF61", 
      maximum.level = 1,
      averagelab = "Average Wavelet Power",
      periodlab = "Period",
      legend.coords = "topright",
      main = condition)}
}

#image plot of the wavelet power spectrum of a time series
plot.wt.image <- function(wavelet_list) {
  
  for (condition in names(wavelet_list)) {
    extract <- wavelet_list[[condition]] 
    
    WaveletComp::wt.image(extract,
         plot.coi = FALSE,
         siglvl = siglvl,
         color.key = "i",
         color.palette = "rainbow(n.levels, start = 0, end = .7)",
         timelab = "Flash Number",
         spec.time.axis = list(at = c(4,8,12,16,20,24,28,32)),
         periodlab = "Period",
         main = condition)}
}
```


# Takuvik

### Fc
```{r import Fc data}
Fc_data <- list.files(path = DataIn, pattern = paste(Fc,FileID, sep = "_"), full.names = TRUE) %>%
  readRDS() 

Fc_data <- summaryBy(FvFmrunnorm ~ Temp_C + PulseSpace_s + Flashnumber, data=Fc_data, FUN=mean, keep.names = TRUE) %>%
  mutate(Condition = paste0(Temp_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Fc}
Fc_wavelets <- wavelet(Fc_data)
```

```{r evaluate significance Tp}
#par(mar=c(3,3,3,3))
#layout(mat = matrix(c(1,6,2,7,3,8,4,9,5, 10), 
#                        nrow = 2, 
#                        ncol = 5))
plot.wt.avg(Fc_wavelets) #no 4-period significance at 2C_16s & 10C_16s, borderline at 6C_16s
```

```{r reconstruct waves Fc}
Fc_reconstruction <- reconstructwave(Fc_wavelets)
```

```{r damping index Fc}
Fc_damping <- damping(Fc_reconstruction) %>% 
  mutate(Species = Fc) %>%
  mutate(damping.index = ifelse(condition %in% c("2C_16s", "6C_16s", "10C_16s"), 0, damping.index)) 
```


# Ottawa 

### Ci
```{r import Ci data }
Ci_data <- list.files(path = DataIn, pattern = paste(Ci,FileID, sep = "_"), full.names = TRUE) %>%
   readRDS() 

Ci_data <- summaryBy(FvFmrunnorm ~ Temp_C + PulseSpace_s + Flashnumber, data=Ci_data, FUN=c(mean), keep.names = TRUE) %>%
  mutate(Condition = paste0(Temp_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Ci}
Ci_wavelets <- wavelet(Ci_data)
```

```{r evaluate significance Ci}
plot.wt.avg(Ci_wavelets) #no 4-period significance at 4C_16s, 8C_8s, 8C_16s, 12C_8s, 12C_16s 
```

```{r reconstruct waves Ci}
Ci_reconstruction <- reconstructwave(Ci_wavelets)
```

```{r damping index Ci}
Ci_damping <- damping(Ci_reconstruction) %>% 
  mutate(Species = Ci) %>%
  mutate(damping.index = ifelse(condition %in% c("4C_16s", "8C_8s", "8C_16s", "12C_8s", "12C_16s"), 0, damping.index))
```


### Cm 
```{r import Cm data}
Cm_data <- list.files(path = DataIn, pattern = paste(Cm, FileID, sep = "_"), full.names = TRUE) %>% 
  readRDS()

Cm_data <- summaryBy(FvFmrunnorm ~ Temp_C + PulseSpace_s + Flashnumber, data=Cm_data, FUN=c(mean), keep.names = TRUE) %>% 
  mutate(Condition = paste0(Temp_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Cm}
Cm_wavelets <- wavelet(Cm_data)
```

```{r evaluate significance Cm}
plot.wt.avg(Cm_wavelets) #no 4-period significance at 4C_16s, 8C_8s, 8C_16s, 12C_16s
```

```{r reconstruct wave Cm}
Cm_reconstruction <- reconstructwave(Cm_wavelets)
```

```{r damping index Cm}
Cm_damping <- damping(Cm_reconstruction) %>%
  mutate(Species = Cm) %>%
  mutate(damping.index = ifelse(condition %in% c("4C_16s", "8C_8s", "8C_16s", "12C_16s"), 0, damping.index))
```


### Cp
```{r import Cp data}
Cp_data <- list.files(path = DataIn, pattern = paste(Cp,FileID, sep = "_"), full.names = TRUE) %>%
   readRDS()

Cp_data <- summaryBy(FvFmrunnorm ~ Temp_C + PulseSpace_s + Flashnumber, data=Cp_data, FUN=c(mean), keep.names = TRUE) %>%
  mutate(Condition = paste0(Temp_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Cp}
Cp_wavelets <- wavelet(Cp_data)
```

```{r evaluate significance Cp}
plot.wt.avg(Cp_wavelets) #no 4-period significance at 4C_16s, 8C_8s, 8C_16s, 12C_8s, 12C_16s
```

```{r reconstruct wave Cp}
Cp_reconstruction <- reconstructwave(Cp_wavelets)
```

```{r damping index Cp}
Cp_damping <- damping(Cp_reconstruction) %>%
  mutate(Species = Cp) %>%
  mutate(damping.index = ifelse(condition %in% c("4C_16s", "8C_8s", "8C_16s", "12C_8s", "12C_16s"), 0, damping.index))
```


### Cr
```{r import Cr data}
Cr_data <- list.files(path = DataIn, pattern = paste(Cr,FileID, sep = "_"), full.names = TRUE) %>% 
  readRDS()

Cr_data <- summaryBy(FvFmrunnorm ~ Temp_C + PulseSpace_s + Flashnumber, data=Cr_data, FUN=c(mean), keep.names = TRUE) %>% 
  mutate(Condition = paste0(Temp_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Cr}
Cr_wavelets <- wavelet(Cr_data)
```

```{r evaluate significance Cr}
plot.wt.avg(Cr_wavelets) #no 4-period significance at 16C_2,4,8,16 or 18s & 20/24C (all spacings)
```

```{r reconstruct wave Cr}
Cr_reconstruction <- reconstructwave(Cr_wavelets)
```

```{r damping index Cr}
Cr_damping <- damping(Cr_reconstruction) %>%
  mutate(Species = Cr) %>%
  mutate(damping.index = ifelse(condition %in% c("16C_4s", "16C_8s", "16C_16s","20C_1s", "20C_2s", "20C_4s", "20C_8s", "20C_16s","24C_1s", "24C_2s", "24C_4s", "24C_8s", "24C_16s"), 0, damping.index))
```


# Sackville 

### Cv
```{r import clean  data}
Cv_data <- list.files(path = DataIn, pattern = paste(Cv, FileID, sep = "_"), full.names = TRUE) %>%
   readRDS()

Cv_data <- summaryBy(FvFmrunnorm ~ Temp_C + PulseSpace_s + Flashnumber, data=Cv_data, FUN=c(mean), keep.names = TRUE) %>% 
  mutate(Condition = paste0(Temp_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Cv}
Cv_wavelets <- wavelet(Cv_data)
```

```{r evaluate significance Cv}
plot.wt.avg(Cv_wavelets) #no 4-period significance at 10C_8s, 10C_16s, 14C_8s, 14C_16s, 18C_2,4,8,16s, 22C_allspacings
```

```{r reconstruct wave Cv}
Cv_reconstruction <- reconstructwave(Cv_wavelets)
```

```{r damping index Cv}
Cv_damping <- damping(Cv_reconstruction) %>%
  mutate(Species = Cv) %>%
  mutate(damping.index = ifelse(condition %in% c("10C_8s", "10C_16s", "14C_8s", "14C_16s", "18C_2s","18C_4s", "18C_8s", "18C_16s", "22C_1s", "22C_2s", "22C_4s", "22C_8s", "22C_16s"), 0, damping.index))
```


### Tp
```{r import Tp data}
Tp_data <- list.files(path = DataIn, pattern = paste(Tp ,FileID, sep = "_"), full.names = TRUE)  %>%
  readRDS()

Tp_data <- summaryBy(FvFmrunnorm ~ Temp_C + PulseSpace_s + Flashnumber, data=Tp_data, FUN=c(mean), keep.names = TRUE) %>% 
  mutate(Condition = paste0(Temp_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Tp}
Tp_wavelets <- wavelet(Tp_data)
```

```{r evaluate significance Tp}
plot.wt.avg(Tp_wavelets) #no 4-period significance at 10C_8s, 14C_8s, 18C_allspacings, 22C_2s, 22C_8s
```

```{r reconstruct wave Tp}
Tp_reconstruction <- reconstructwave(Tp_wavelets)
```

```{r damping index Cv}
Tp_damping <- damping(Tp_reconstruction) %>%
  mutate(Species = Tp) %>%
  mutate(damping.index = ifelse(condition %in% c("10C_8s", "14C_8s", "18C_1s", "18C_2s","18C_4s", "18C_8s", "22C_2s", "22C_8s"), 0, damping.index))
```

# Merging Results 

```{r merge}
sstate_damping <- rbind(Fc_damping, Ci_damping, Cm_damping, Cp_damping, Cr_damping, Cv_damping, Tp_damping) %>%
  relocate(Species, .before = condition) %>%
  separate(condition, into=c("Temp_C", "PulseSpace_s"), sep = "_") %>%
  mutate(PulseSpace_s = str_remove(PulseSpace_s, "s")) %>%
  mutate(Temp_C = str_remove(Temp_C, "C")) %>%
  rename(DampingIndex = damping.index) 
```

```{r saving as RDS}
#save as RDS to be able to work on figures without running wavelet transformations
saveRDS(sstate_damping, file.path(DataOut, paste(Project, "SState_Damping.RDS", sep = "_"), fsep = .Platform$file.sep))
```


# Figures 
```{r import RDS}
#sstate_damping <- readRDS("../Data/ProcessedData/LOW_SState_Damping.Rds")
```

"1", "2", "4", "8", "16"
```{r figure setup}
sstate_damping$PulseSpace_s <- factor(sstate_damping$PulseSpace_s, levels = c("16","8","4","2","1"))
sstate_damping$Temp_C <- factor(sstate_damping$Temp_C, levels = c("0","2","4","6","8","10","12","14","16","18","20","22","24"))

species.labs <- c("Chlamydomonas ICEMDV", "Chlamydomonas malina", "Chlamydomonas priscuii", "Chlamydomonas reinhardtii", "Chlorella vulgaris", "Fragilariopsis cylindrus", "Thalassiosira pseudonana")
names(species.labs) <- c("Chlamydomonas_ICEMDV", "Chlamydomonas_malina", "Chlamydomonas_priscuii", "Chlamydomonas_reinhardtii", "Chlorella_vulgaris", "Fragilariopsis_cylindrus", "Thalassiosira_pseudonana")
```
 

```{r heat map}
sstate_damping %>% 
  ggplot() + 
  geom_tile(aes(x = Temp_C, y = PulseSpace_s, fill = DampingIndex)) +  
  viridis::scale_fill_viridis(option="magma") + 
  facet_wrap(vars(Species), scales = "free", labeller = labeller(Species=species.labs)) +  
  theme_linedraw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 

#ggsave("heatmap20240209.png", width = 7.63, height = 4.89, dpi = 900,
#      plot=last_plot(),
#      path="~/Downloads")
```


```{r line plot}
sstate_damping %>% 
  ggplot() + 
  geom_point(aes(x = PulseSpace_s, y = DampingIndex, colour = Temp_C)) +
  geom_line(aes(x = as.numeric(PulseSpace_s), y = DampingIndex, colour = Temp_C)) +
  viridis::scale_color_viridis(option="inferno", discrete=TRUE) + 
  facet_wrap(vars(Species), scales = "free", labeller = labeller(Species=species.labs)) +  
  theme_linedraw() +
  theme(strip.text = element_text(face = "italic"))
```

```{r ggplot alternative to layer wt.avg}
#in progress 
WT <- Fc_wavelets[["0C_1s"]]
Power.avg = WT$Power.avg
Power.avg.pval = WT$Power.avg.pval
Period = WT$Period
df <- data.frame(Power.avg, Power.avg.pval, Period) %>%
  mutate(Power.avg.pval = ifelse(Power.avg.pval > siglvl , NA, Power.avg.pval)) %>%
  mutate(Power.avg.pval = ifelse(Power.avg.pval <= siglvl , 1, Power.avg.pval)) %>%
  mutate(condition= "0C_1s")

WT2 <- Fc_wavelets[["0C_2s"]]
Power.avg2 = WT2$Power.avg
Power.avg.pval2 = WT2$Power.avg.pval
Period2 = WT2$Period
df2 <- data.frame(Power.avg2, Power.avg.pval2, Period2) %>%
  mutate(Power.avg.pval2 = ifelse(Power.avg.pval2 > siglvl , NA, Power.avg.pval2)) %>%
  mutate(Power.avg.pval2 = ifelse(Power.avg.pval2 <= siglvl , 1, Power.avg.pval2)) %>%
  mutate(condition = "0C_2s")

ggplot(NULL)+
  geom_point(data=df, aes(x=Power.avg, y= Period, col=Power.avg.pval)) +
  geom_point(data=df2, aes(x=Power.avg2, y= Period2, col=Power.avg.pval2)) +
  xlim(0, 1) + 
  theme_bw() 
```

# Previous Methods

Original method by Max
```{r}
# LOW_SolFits_1s_10C <- LOW_SolFits %>%
#   filter(Temp_C == "10",
#          PulseSpace_s == 1)
# 
# WVT_10C_1s <- analyze.wavelet(LOW_SolFits_1s_10C, "FvFm",
#                         method = "white.noise",
#                         loess.span = 0, 
#                         dt = 1, dj = 1/500,
#                         lowerPeriod = 2, upperPeriod = 36,
#                         make.pval =TRUE, n.sim = 100)
# 
# MP_DeSpBl <- max(WVT_10C_1s$Power)
# 
# #sequential lines act like they are piped; need to run as a unit
# #png(filename = "../Output/AvPw_WT_LOW_Fragilariopsis_SolFits_1s_10C.png")
# wt.avg(WVT_10C_1s, show.siglvl = TRUE, siglvl =  0.05,maximum.level = 1,   #set level to mark significance
# periodlab = "Periodicity",
# main = "Fragilariopsis 10C, Pulse space 1 sec")
# #dev.off()
# 
# #y axis is log2 scale not linear
# #png(filename = "../Output/WT_LOW_Fragilariopsis_SolFits_1s_10C.png")
# wt.image(WVT_10C_1s, periodlab = "Periodicity",
# legend.params = list(lab = "wavelet power levels"),
# label.time.axis = TRUE,
# plot.legend = TRUE, plot.contour = TRUE,
# maximum.level = 1.001 * MP_DeSpBl,
# show.date = TRUE, date.format = "%F %S",
# main = "Fragilariopsis 10C, Pulse space 1 sec")
# #dev.off()

```
