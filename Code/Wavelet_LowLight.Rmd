---
title: "Wavelet Transformation"
author:
- Natasha Ryan
- Maximilian Berthold
date: "`r format(Sys.Date())`"
output:
  html_document:
    df_print: paged
    code_folding: hide
    keep_md: yes
    fig_caption: yes
    toc: TRUE
    toc_float: TRUE   
csl: plos-one.csl
editor_options: 
  chunk_output_type: inline
---

# Introduction
This RMD computes a wave transformation and extracts the duration of fluorescence oscillations for the cleaned data generated from OttawaImport, TakuvikImport, and SackvilleImport. 

```{r load libraries}
library(tidyverse)
library(doBy)
library(WaveletComp)
```


# Set Project Variables
```{r set project variables}
Project <- "LOW"
DataIn <- file.path("..","Data", "CleanData")
CalibData <- file.path("..","Data", "CalibData")
DataOut <- file.path("..","Data", "ProcessedData")
FileID <- "SolFitsTrim"
siglvl <- 0.05 #specifies statistical significance level
Fc <- "Fragilariopsis_cylindrus"
Ci <- "Chlamydomonas_ICEMDV"
Cm <- "Chlamydomonas_malina"
Cp <- "Chlamydomonas_priscuii"
Cr <- "Chlamydomonas_reinhardtii"
Cv <- "Chlorella_vulgaris"
Tp <- "Thalassiosira_pseudonana"
```


```{r create functions}
#function for wavelet transformation 
wavelet <- function(data_list){
  wavelet_list <- lapply(data_list, function(data) {
    WaveletComp::analyze.wavelet(data, "FvFmrunnorm",
                                 method = "white.noise",
                                 loess.span = 0.75, 
                                 dt = 1, dj=1/250, 
                                 n.sim = 300, 
                                 verbose = FALSE)
  })
return(wavelet_list)
}


#function for wavelet reconstruction, applies reconstruct() function from WaveletComp to all wavelets in a list
reconstructwave <- function(wavelet_list) {
  reconstructed_list <- lapply(wavelet_list, function(wave) {
    WaveletComp::reconstruct(wave, siglvl = siglvl, 
                             #plot.waves = TRUE,
                             plot.rec = FALSE,
                             lwd = 1.5, 
                             col=c("#0E1126","#429F78"), 
                             legend.coords = "topright",
                             legend.text = c("Original", "Reconstructed"),
                             timelab = "Flash Number", 
                             verbose = FALSE)
 })
  return(reconstructed_list) 
}


#function to extract the number of oscillating flashes from the reconstruction 
damping <- function(reconstructed) {
  result_list <- lapply(reconstructed, function(condition) {
    return(condition$series)
  }) #extract reconstructed wave data from 'reconstruct' objects 
  result_df <- data.frame(condition = character(0), damping.index = integer(0), stringsAsFactors = FALSE)
  
  for (condition in names(result_list)) {
    extract <- result_list[[condition]] 
    
    extract$difference <- c(NA, diff(extract$`FvFmrunnorm.r`)) #calculate difference in reconstructed FvFm values between successive rows 
    
    cycling.flashes <- which(extract$difference != 0) #extract row index where FvFm is oscillating
    
    damping.index <- max(cycling.flashes) #extract the highest row index (last row before FvFm damps)
    
    result_df <- rbind(result_df, data.frame(condition = condition, damping.index = damping.index))
  }
  return(result_df)
}

# Returns conditions with significant periodicity at 4 
wt.significance <- function(wavelets) {
  result_list <- lapply(names(wavelets), function(condition_name) {
    condition <- wavelets[[condition_name]]
    Power.avg <- condition$Power.avg
    Power.avg.pval <- condition$Power.avg.pval
    Period <- condition$Period
    Condition <- rep(condition_name, length(Power.avg))  
    df <- data.frame(Power.avg, Power.avg.pval, Period, Condition)
    
    return(df)
  })

  result_df <- bind_rows(result_list) %>%
    filter(Power.avg.pval <= siglvl) %>%
    filter(between(Period, 3.9, 4.1))
  
    significantconditions <- unique(result_df$Condition)
  
  return(significantconditions)
}


#plot of wavelet power averages across time, indicates which conditions show a significant periodicity of 4
plot.wt.avg <- function(wavelet_list) {
  
  for (condition in names(wavelet_list)) {
    extract <- wavelet_list[[condition]] 
    
    WaveletComp::wt.avg(extract, siglvl = siglvl,
      sigcol = "#71CF61", 
      maximum.level = 1,
      averagelab = "Average Wavelet Power",
      periodlab = "Period",
      legend.coords = "topright",
      main = condition)}
}

#image plot of the wavelet power spectrum of a time series
plot.wt.image <- function(wavelet_list) {
  
  for (condition in names(wavelet_list)) {
    extract <- wavelet_list[[condition]] 
    
    WaveletComp::wt.image(extract,
         plot.coi = FALSE,
         siglvl = siglvl,
         color.key = "i",
         color.palette = "rainbow(n.levels, start = 0, end = .7)",
         timelab = "Flash Number",
         spec.time.axis = list(at = c(4,8,12,16,20,24,28,32)),
         periodlab = "Period",
         main = condition)}
}
```


# Takuvik

### Fc grown at 0C
```{r import Fc G0 data}
FcG0_data <- list.files(path = DataIn, pattern = paste(Fc,"G0", FileID, sep = "_"), full.names = TRUE) %>%
  readRDS()

FcG0_data <- summaryBy(FvFmrunnorm ~ TempDiff_C + PulseSpace_s + Flashnumber, data=FcG0_data, FUN=mean, keep.names = TRUE) %>%
  mutate(Condition = paste0(TempDiff_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Fc G0}
FcG0_wavelets <- wavelet(FcG0_data)
```

```{r evaluate significance Fc G0}
FcG0_significant <- wt.significance(FcG0_wavelets)
plot.wt.avg(FcG0_wavelets)
```

```{r reconstruct waves Fc G0}
FcG0_reconstruction <- reconstructwave(FcG0_wavelets)
```

```{r damping index Fc G0}
FcG0_damping <- damping(FcG0_reconstruction) %>% 
  mutate(Species = Fc) %>%
  mutate(damping.index = ifelse(!condition %in% FcG0_significant, 0, damping.index)) 
```

### Fc grown at 6C
```{r import Fc G6 data}
FcG6_data <- list.files(path = DataIn, pattern = paste(Fc,"G6", FileID, sep = "_"), full.names = TRUE) %>%
  readRDS()

FcG6_data <- summaryBy(FvFmrunnorm ~ TempDiff_C + PulseSpace_s + Flashnumber, data=FcG6_data, FUN=mean, keep.names = TRUE) %>%
  mutate(Condition = paste0(TempDiff_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Fc G6}
FcG6_wavelets <- wavelet(FcG6_data)
```

```{r evaluate significance Fc G6}
FcG6_significant <- wt.significance(FcG6_wavelets)
plot.wt.avg(FcG6_wavelets)
```

```{r reconstruct waves Fc G6}
FcG6_reconstruction <- reconstructwave(FcG6_wavelets)
```

```{r damping index Fc G6}
FcG6_damping <- damping(FcG6_reconstruction) %>% 
  mutate(Species = Fc) %>%
  mutate(damping.index = ifelse(!condition %in% FcG6_significant, 0, damping.index)) 
```



# Ottawa 

### Ci
```{r import Ci data }
Ci_data <- list.files(path = DataIn, pattern = paste(Ci,FileID, sep = "_"), full.names = TRUE) %>%
   readRDS() 

Ci_data <- summaryBy(FvFmrunnorm ~ TempDiff_C + PulseSpace_s + Flashnumber, data=Ci_data, FUN=c(mean), keep.names = TRUE) %>%
  mutate(Condition = paste0(TempDiff_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Ci}
Ci_wavelets <- wavelet(Ci_data)
```

```{r evaluate significance Ci}
Ci_significant <- wt.significance(Ci_wavelets)
plot.wt.avg(Ci_wavelets)
```

```{r reconstruct waves Ci}
Ci_reconstruction <- reconstructwave(Ci_wavelets)
```

```{r damping index Ci}
Ci_damping <- damping(Ci_reconstruction) %>% 
  mutate(Species = Ci) %>%
  mutate(damping.index = ifelse(!condition %in% Ci_significant, 0, damping.index))
```


### Cm 
```{r import Cm data}
Cm_data <- list.files(path = DataIn, pattern = paste(Cm, FileID, sep = "_"), full.names = TRUE) %>% 
  readRDS()

Cm_data <- summaryBy(FvFmrunnorm ~ TempDiff_C + PulseSpace_s + Flashnumber, data=Cm_data, FUN=c(mean), keep.names = TRUE) %>% 
  mutate(Condition = paste0(TempDiff_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Cm}
Cm_wavelets <- wavelet(Cm_data)
```

```{r evaluate significance Cm}
Cm_significant <- wt.significance(Cm_wavelets)
plot.wt.avg(Cm_wavelets) 
```

```{r reconstruct wave Cm}
Cm_reconstruction <- reconstructwave(Cm_wavelets)
```

```{r damping index Cm}
Cm_damping <- damping(Cm_reconstruction) %>%
  mutate(Species = Cm) %>%
  mutate(damping.index = ifelse(!condition %in% Cm_significant, 0, damping.index))
```


### Cp
```{r import Cp data}
Cp_data <- list.files(path = DataIn, pattern = paste(Cp,FileID, sep = "_"), full.names = TRUE) %>%
   readRDS()

Cp_data <- summaryBy(FvFmrunnorm ~ TempDiff_C + PulseSpace_s + Flashnumber, data=Cp_data, FUN=c(mean), keep.names = TRUE) %>%
  mutate(Condition = paste0(TempDiff_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Cp}
Cp_wavelets <- wavelet(Cp_data)
```

```{r evaluate significance Cp}
Cp_significant <- wt.significance(Cp_wavelets)
plot.wt.avg(Cp_wavelets) 
```

```{r reconstruct wave Cp}
Cp_reconstruction <- reconstructwave(Cp_wavelets)
```

```{r damping index Cp}
Cp_damping <- damping(Cp_reconstruction) %>%
  mutate(Species = Cp) %>%
  mutate(damping.index = ifelse(!condition %in% Cp_significant, 0, damping.index))
```


### Cr
```{r import Cr data}
Cr_data <- list.files(path = DataIn, pattern = paste(Cr,FileID, sep = "_"), full.names = TRUE) %>% 
  readRDS()

Cr_data <- summaryBy(FvFmrunnorm ~ TempDiff_C + PulseSpace_s + Flashnumber, data=Cr_data, FUN=c(mean), keep.names = TRUE) %>% 
  mutate(Condition = paste0(TempDiff_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Cr}
Cr_wavelets <- wavelet(Cr_data)
```

```{r evaluate significance Cr}
Cr_significant <- wt.significance(Cr_wavelets)
plot.wt.avg(Cr_wavelets) 
```

```{r reconstruct wave Cr}
Cr_reconstruction <- reconstructwave(Cr_wavelets)
```

```{r damping index Cr}
Cr_damping <- damping(Cr_reconstruction) %>%
  mutate(Species = Cr) %>%
  mutate(damping.index = ifelse(!condition %in% Cr_significant, 0, damping.index))
```


# Sackville 

### Cv
```{r import clean  data}
Cv_data <- list.files(path = DataIn, pattern = paste(Cv, FileID, sep = "_"), full.names = TRUE) %>%
   readRDS()

Cv_data <- summaryBy(FvFmrunnorm ~ TempDiff_C + PulseSpace_s + Flashnumber, data=Cv_data, FUN=c(mean), keep.names = TRUE) %>% 
  mutate(Condition = paste0(TempDiff_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Cv}
Cv_wavelets <- wavelet(Cv_data)
```

```{r evaluate significance Cv}
Cv_significant <- wt.significance(Cv_wavelets)
plot.wt.avg(Cv_wavelets) 
```

```{r reconstruct wave Cv}
Cv_reconstruction <- reconstructwave(Cv_wavelets)
```

```{r damping index Cv}
Cv_damping <- damping(Cv_reconstruction) %>%
  mutate(Species = Cv) %>%
  mutate(damping.index = ifelse(!condition %in% Cv_significant, 0, damping.index))
```


### Tp
```{r import Tp data}
Tp_data <- list.files(path = DataIn, pattern = paste(Tp ,FileID, sep = "_"), full.names = TRUE)  %>%
  readRDS()

Tp_data <- summaryBy(FvFmrunnorm ~ TempDiff_C + PulseSpace_s + Flashnumber, data=Tp_data, FUN=c(mean), keep.names = TRUE) %>% 
  mutate(Condition = paste0(TempDiff_C,"C","_",PulseSpace_s,"s")) %>%
  split_by("Condition")
```

```{r wavelet transformation Tp}
Tp_wavelets <- wavelet(Tp_data)
```

```{r evaluate significance Tp}
Tp_significant <- wt.significance(Tp_wavelets)
plot.wt.avg(Tp_wavelets) 
```

```{r reconstruct wave Tp}
Tp_reconstruction <- reconstructwave(Tp_wavelets)
```


```{r damping index Cv}
Tp_damping <- damping(Tp_reconstruction)  %>%
  mutate(Species = Tp) %>%
  mutate(damping.index = ifelse(!condition %in% Tp_significant, 0, damping.index)) 
```

# Merging Results 

```{r merge}
sstate_damping <- rbind(FcG0_damping, FcG6_damping, Ci_damping, Cm_damping, Cp_damping, Cr_damping, Cv_damping, Tp_damping) %>%
  relocate(Species, .before = condition) %>%
  separate(condition, into=c("TempDiff_C", "PulseSpace_s"), sep = "_") %>%
  mutate(PulseSpace_s = str_remove(PulseSpace_s, "s")) %>%
  mutate(TempDiff_C = str_remove(TempDiff_C, "C")) %>%
  rename(DampingIndex = damping.index) 
```

```{r saving as RDS}
#save as RDS to be able to work on figures without running wavelet transformations
saveRDS(sstate_damping, file.path(DataOut, paste(Project, "SState_Damping.RDS", sep = "_"), fsep = .Platform$file.sep))
```


# Figures 
```{r import RDS}
#sstate_damping <- readRDS("../Data/ProcessedData/LOW_SState_Damping.Rds")
```

```{r figure setup}
sstate_damping$PulseSpace_s <- factor(sstate_damping$PulseSpace_s, levels = c("1", "2", "4", "8", "16"))
sstate_damping$TempDiff_C <- factor(sstate_damping$TempDiff_C, levels= #c("0","2","4","6","8","10","12","14","16","18","20","22","24"))
c("-12","-8","-6","-4","0","2","4","6","8","10"))

sstate_damping$Species <- factor(sstate_damping$Species, levels= c("Fragilariopsis_cylindrus", "Thalassiosira_pseudonana","Chlamydomonas_ICEMDV", "Chlamydomonas_reinhardtii", "Chlamydomonas_malina", "Chlorella_vulgaris", "Chlamydomonas_priscuii"))
                                                                   
species.labs <- c("Fragilariopsis cylindrus", "Thalassiosira pseudonana", "Chlamydomonas ICEMDV", "Chlamydomonas malina", "Chlamydomonas priscuii", "Chlamydomonas reinhardtii", "Chlorella vulgaris")
names(species.labs) <- c("Fragilariopsis_cylindrus", "Thalassiosira_pseudonana", "Chlamydomonas_ICEMDV", "Chlamydomonas_malina", "Chlamydomonas_priscuii", "Chlamydomonas_reinhardtii", "Chlorella_vulgaris")
```


```{r heat map}
sstate_damping %>% 
  ggplot() + 
  geom_tile(aes(x = TempDiff_C, y = PulseSpace_s, fill = DampingIndex)) +  
  viridis::scale_fill_viridis(option="mako", na.value="white") + 
  facet_wrap(vars(Species), ncol=2, scales = "free", labeller = labeller(Species=species.labs)) + 
  labs(x= "Measurement Temperature (Â°C)", y= "Spacing of Photon Delivery (s)", fill= "Duration of PSII Cycling") +
  theme_linedraw() +
  theme(text = element_text(family = "Palatino"), 
        strip.background =element_rect(fill="white"), 
        strip.text = element_text(colour= "black",face = "italic", size = 13),
        axis.text=element_text(size=13), axis.title=element_text(size=14),
        legend.text=element_text(size=13), legend.title=element_text(size=14), 
        legend.position = c(0.75, 0.1), 
        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```


```{r}
sstate_damping %>% 
  filter(Species %in% c("Fragilariopsis_cylindrus", "Thalassiosira_pseudonana")) %>%
  ggplot() + 
  geom_tile(aes(x = TempDiff_C, y = PulseSpace_s, fill = DampingIndex)) +  
  viridis::scale_fill_viridis(option="mako", na.value="white") + 
  facet_wrap(vars(Species), labeller = labeller(Species=species.labs)) +  
  theme_linedraw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 

sstate_damping %>% 
  filter(!Species %in% c("Fragilariopsis_cylindrus", "Thalassiosira_pseudonana")) %>%
  ggplot() + 
  geom_tile(aes(x = TempDiff_C, y = PulseSpace_s, fill = DampingIndex)) +  
  viridis::scale_fill_viridis(option="mako", na.value="white") + 
  facet_wrap(vars(Species), labeller = labeller(Species=species.labs)) +  
  theme_linedraw() +
  theme(strip.text = element_text(face = "italic")) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 
```

```{r}
library(mgcv)
gam.polar.algae <- gam(DampingIndex ~ s(TempDiff_C,k=3) + s(PulseSpace_s, k=4), 
                data = subset(sstate_damping, Species %in% c("Chlamydomonas_malina", 
                                                             "Chlamydomonas_priscuii",
                                                             "Chlamydomonas_ICEMDV")))

gam.temperate.algae <- gam(DampingIndex ~ TempDiff_C + PulseSpace_s, 
                data = subset(sstate_damping, Species %in% c("Chlamydomonas_reinhardtii", 
                                                             "Chlorella_vulgaris")))


```

```{r}
vis.gam(gam.polar.algae, plot.type = "contour")
vis.gam(gam.temperate.algae, plot.type = "contour")

```


```{r}
sstate_damping$PulseSpace_s <- as.numeric(sstate_damping$PulseSpace_s)
sstate_damping$TempDiff_C <- as.numeric(sstate_damping$TempDiff_C)
```




# Previous Methods

Original method by Max
```{r}
# LOW_SolFits_1s_10C <- LOW_SolFits %>%
#   filter(TempDiff_C == "10",
#          PulseSpace_s == 1)
# 
# WVT_10C_1s <- analyze.wavelet(LOW_SolFits_1s_10C, "FvFm",
#                         method = "white.noise",
#                         loess.span = 0, 
#                         dt = 1, dj = 1/500,
#                         lowerPeriod = 2, upperPeriod = 36,
#                         make.pval =TRUE, n.sim = 100)
# 
# MP_DeSpBl <- max(WVT_10C_1s$Power)
# 
# #sequential lines act like they are piped; need to run as a unit
# #png(filename = "../Output/AvPw_WT_LOW_Fragilariopsis_SolFits_1s_10C.png")
# wt.avg(WVT_10C_1s, show.siglvl = TRUE, siglvl =  0.05,maximum.level = 1,   #set level to mark significance
# periodlab = "Periodicity",
# main = "Fragilariopsis 10C, Pulse space 1 sec")
# #dev.off()
# 
# #y axis is log2 scale not linear
# #png(filename = "../Output/WT_LOW_Fragilariopsis_SolFits_1s_10C.png")
# wt.image(WVT_10C_1s, periodlab = "Periodicity",
# legend.params = list(lab = "wavelet power levels"),
# label.time.axis = TRUE,
# plot.legend = TRUE, plot.contour = TRUE,
# maximum.level = 1.001 * MP_DeSpBl,
# show.date = TRUE, date.format = "%F %S",
# main = "Fragilariopsis 10C, Pulse space 1 sec")
# #dev.off()

```
